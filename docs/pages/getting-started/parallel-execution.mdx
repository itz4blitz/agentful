# Parallel Execution

Run agents in parallel for 2-3x faster development.

## Quick Start

```bash
# Enable parallel execution
agentful parallel enable

# Restart Claude Code
claude

# Agents now run in parallel automatically
/agentful-start
```

---

## How It Works

### Before (Sequential)
```
Backend:  ████████░░░░░░░░  (5 min)
Frontend:         ████████░░  (5 min)
Tester:                  ███  (3 min)
Total: 13 minutes
```

### After (Parallel)
```
Backend:  ████████  (5 min)
Frontend: ████████  (5 min) ← same time
Tester:   ███       (3 min) ← same time
Total: 5 minutes (62% faster)
```

---

## Setup

### Step 1: Check if Available

```bash
agentful parallel detect
```

**Possible outcomes:**

✅ **Enabled**
```
✓ Parallel execution is enabled
  Method: native
```
You're good to go!

⚠️ **Can Enable**
```
⚠ Parallel execution is NOT enabled
  Reason: TeammateTool present but gated (requires patch)

  Run: agentful parallel enable
```
Continue to Step 2.

❌ **Not Available**
```
⚠ Parallel execution is NOT enabled
  Reason: Claude Code version too old
```
Upgrade Claude Code: `npm install -g @anthropic-ai/claude-code@latest`

### Step 2: Enable Parallel Mode

```bash
agentful parallel enable
```

**What this does:**
1. Finds your Claude Code installation
2. Creates backup of CLI (`cli.js.backup-<timestamp>`)
3. Patches gate function to enable TeammateTool
4. Saves patched version

**Output:**
```
✓ Parallel execution enabled successfully!
  Backup saved: /usr/local/lib/node_modules/@anthropic-ai/claude-code/cli.js.backup-1738195200000

  Restart Claude Code to use parallel execution:
    claude
    /agentful-start
```

### Step 3: Verify

```bash
agentful parallel status
```

**Expected:**
```
Parallel Execution Status:

  Parallel: Enabled
  Method: native
  Can Enable: No
```

---

## Usage

Once enabled, parallel execution happens automatically when agents work on independent tasks.

### Orchestrator Decides

The orchestrator automatically chooses parallel or sequential based on task dependencies:

**Parallel (Automatic):**
```javascript
// Login feature - independent work
backend:  Implement POST /api/auth/login  (src/api/auth.ts)
frontend: Create LoginForm component      (src/components/LoginForm.tsx)
tester:   Write test fixtures             (tests/fixtures/users.json)
// ✅ No file conflicts → parallel execution
```

**Sequential (Automatic):**
```javascript
// Frontend needs API response shape first
backend:  Implement API                   → returns {token, user}
frontend: Create UI using API response    → needs {token, user} shape
// ❌ Dependency → sequential execution
```

---

## When Parallel Helps

### ✅ High Impact Scenarios

| Scenario | Time Saved | Why |
|----------|------------|-----|
| Backend + Frontend | 50-60% | Different files, independent work |
| Multiple test types | 40-50% | Unit + integration + E2E in parallel |
| Independent features | 60-70% | Auth + Dashboard at same time |
| Analysis tasks | 30-40% | Architect analyzing while backend codes |

### ⚠️ Low Impact Scenarios

| Scenario | Sequential Better | Why |
|----------|-------------------|-----|
| Quality gates | Always | Must validate in order (code → tests → review) |
| Dependent tasks | Always | Frontend needs API shape from backend |
| File conflicts | Always | Both agents editing same file |
| Small tasks | Maybe | Overhead not worth it (<2 min tasks) |

---

## Troubleshooting

### "Failed to enable" Error

**Cause:** Cannot find Claude Code installation

**Fix:**
```bash
# Check if Claude Code is installed
which claude

# Reinstall if missing
npm install -g @anthropic-ai/claude-code
```

### Parallel Mode Not Working After Enable

**Symptoms:** Agents still run sequentially after `agentful parallel enable`

**Fix:**
```bash
# 1. Verify status
agentful parallel status

# 2. Restart Claude Code (important!)
# Exit current session and restart
claude

# 3. Confirm orchestrator sees parallel mode
/agentful-start
# Watch for "Launch these agents in parallel" messages
```

### Claude Code Update Broke Parallel Mode

**Cause:** Claude Code updates overwrite patched CLI

**Fix:**
```bash
# Re-enable after updates
agentful parallel enable
```

**Prevention:** Pin Claude Code version in package.json:
```json
{
  "devDependencies": {
    "@anthropic-ai/claude-code": "2.1.19"
  }
}
```

### Want to Disable Parallel Mode

```bash
# Find backups
ls /usr/local/lib/node_modules/@anthropic-ai/claude-code/cli.js.backup-*

# Restore original (replace <timestamp> with actual)
cp cli.js.backup-<timestamp> cli.js

# Or reinstall Claude Code
npm install -g @anthropic-ai/claude-code --force
```

---

## Technical Details

### How the Patch Works

**Detection:**
```javascript
// Finds this gate function in minified CLI
function i8(){
  if(Yz(process.env.CLAUDE_CODE_AGENT_SWARMS))return!1;
  return xK("tengu_brass_pebble",!1)
}
```

**Patch:**
```javascript
// Replaces with simple return true
function i8(){return!0}
```

This bypasses the statsig feature flag check and enables:
- TeammateTool (multi-agent coordination)
- Delegate mode (background spawning)
- Swarm spawning (1-5 parallel agents)
- Teammate mailbox (inter-agent messaging)

### Graceful Cutover Strategy

**Phase 1 (Now):** Patch-based parallel execution
- Works with current Claude Code
- Requires manual enable
- Breaks on CLI updates

**Phase 2 (Future):** Native SDK support
- When Claude Code adds official parallel Task() API
- agentful auto-detects and switches
- No user action required

**Implementation:**
```javascript
// lib/parallel-execution.js detects native support
if (hasNativeParallelSupport()) {
  method = 'native';  // Future: Use official SDK
} else if (hasPatchedCLI()) {
  method = 'patched'; // Current: Use TeammateTool patch
} else {
  method = 'sequential'; // Fallback
}
```

---

## FAQ

**Q: Is this safe?**
A: Yes. The patch only changes a single gate function and creates backups.

**Q: Will this break on Claude Code updates?**
A: Yes. Re-run `agentful parallel enable` after updates.

**Q: Can I use this in production?**
A: Yes, but test thoroughly. Sequential mode is more stable for critical paths.

**Q: Does this work with all LLM providers?**
A: Yes. Parallel execution works with any provider (Claude, GLM, DeepSeek, etc.).

**Q: How many agents can run in parallel?**
A: Currently 1-5 agents (TeammateTool limit). Sequential has no limit.

**Q: Can I force sequential mode even when parallel is enabled?**
A: Yes. The orchestrator automatically uses sequential when dependencies exist.

---

## Next Steps

- [Background Agent Patterns](/concepts/background-agents) - Deep dive into execution models
- [Git Worktrees](/concepts/git-worktrees) - Parallel development on multiple branches
- [CI Integration](/ci-integration) - Run parallel agents in GitHub Actions
