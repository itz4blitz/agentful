# agentful File Structure Audit - Complete

## Summary

Completed comprehensive audit of all state file references in agentful codebase and ensured proper separation between runtime state (`.agentful/`) and user-customizable config (`.claude/`).

## Changes Made

### 1. Fixed `product-analysis.json` Location

**Issue**: `product-analysis.json` was incorrectly referenced in `.agentful/` when it should be in `.claude/product/`

**Why**: Product analysis is configuration-like (describes spec quality), should be version controlled and shared across team, not transient runtime state.

**Files Updated**:
- `.claude/agents/product-analyzer.md` - 4 references fixed
- `.claude/agents/orchestrator.md` - 2 references fixed
- `.claude/commands/agentful-status.md` - 2 references fixed
- `docs/pages/agents/index.mdx` - 1 reference fixed
- `docs/pages/agents/orchestrator.mdx` - 4 references fixed

**Total**: Fixed all incorrect references. Now consistently using `.claude/product/product-analysis.json`

### 2. Updated Directory Structure Documentation

**Files Enhanced**:
- `docs/pages/index.mdx` - Added complete directory tree with all runtime state files
- `template/CLAUDE.md` - Added `product-analysis.json` and all `.agentful/` files
- `README.md` - Expanded state tracking section with full file list and separation explanation

**Added**:
- `.claude/agents/ephemeral/` directory reference for one-off agents
- All missing runtime state files (`last-validation.json`, `conversation-history.json`)
- Clear annotations: "gitignored, managed by npm package" vs "version controlled"

### 3. Created Comprehensive Documentation

**New Files**:
1. **ARCHITECTURE.md** (11KB)
   - Complete explanation of file organization
   - `.claude/` vs `.agentful/` separation principles
   - Why `product-analysis.json` is in `.claude/` not `.agentful/`
   - Why `.claude/agents/ephemeral/` is gitignored
   - Migration guide for old references
   - Common scenarios (team collaboration, branch switching, etc.)
   - Detailed comparison tables

### 4. Updated .gitignore

Added `.claude/agents/ephemeral/` to gitignore for temporary one-off agents.

## Final Directory Structure

```
your-project/
├── .claude/                # User-customizable configuration (VERSION CONTROL)
│   ├── agents/
│   │   ├── orchestrator.md
│   │   ├── backend.md
│   │   ├── frontend.md
│   │   ├── tester.md
│   │   ├── reviewer.md
│   │   ├── fixer.md
│   │   ├── architect.md
│   │   ├── product-analyzer.md
│   │   └── ephemeral/      # One-off agents (GITIGNORED)
│   ├── commands/
│   │   ├── agentful.md
│   │   ├── agentful-product.md
│   │   ├── agentful-start.md
│   │   ├── agentful-status.md
│   │   ├── agentful-decide.md
│   │   └── agentful-validate.md
│   ├── product/
│   │   ├── index.md        # Main product spec (USER EDITABLE)
│   │   ├── product-analysis.json  # Readiness analysis (GENERATED)
│   │   └── domains/        # Optional hierarchical
│   ├── skills/
│   │   ├── product-tracking/
│   │   ├── validation/
│   │   └── conversation/
│   └── settings.json
│
└── .agentful/              # Runtime state (GITIGNORED, NPM MANAGED)
    ├── state.json
    ├── completion.json
    ├── decisions.json
    ├── architecture.json
    ├── last-validation.json
    └── conversation-history.json
```

## Verification

### Correct References Count
- `.claude/product/product-analysis.json`: **32 references** ✅

### Incorrect References
- `.agentful/product-analysis.json`: **0 references** (except in ARCHITECTURE.md migration examples) ✅

### All State Files Documented
- [x] state.json
- [x] completion.json
- [x] decisions.json
- [x] architecture.json
- [x] last-validation.json
- [x] conversation-history.json

### All Config Files Documented
- [x] product/index.md
- [x] product/product-analysis.json
- [x] product/domains/
- [x] agents/ (core + ephemeral)
- [x] commands/
- [x] skills/
- [x] settings.json

## Key Principles Enforced

1. **`.claude/` = Configuration** (what to build, how to build it)
   - Version controlled ✅
   - Shared across team ✅
   - Human editable ✅

2. **`.agentful/` = Runtime State** (current progress, session state)
   - Gitignored ✅
   - Individual per developer ✅
   - Auto-generated by npm package ✅

3. **Exception: `product-analysis.json`**
   - Lives in `.claude/product/` (not `.agentful/`) ✅
   - Reason: Durable assessment of spec quality, valuable for code review ✅
   - Version controlled with product spec ✅

4. **Exception: `agents/ephemeral/`**
   - Lives in `.claude/agents/ephemeral/` ✅
   - Gitignored (temporary agents) ✅
   - Created/deleted automatically ✅

## Files Modified

### Agent Files
- `.claude/agents/product-analyzer.md`
- `.claude/agents/orchestrator.md`

### Command Files
- `.claude/commands/agentful-status.md`

### Documentation
- `docs/pages/index.mdx`
- `docs/pages/agents/index.mdx`
- `docs/pages/agents/orchestrator.mdx`
- `README.md`
- `template/CLAUDE.md`

### Configuration
- `.gitignore`

### New Files
- `ARCHITECTURE.md` (comprehensive guide)
- `FILE-STRUCTURE-AUDIT.md` (this file)

## Migration Notes for Users

If you have existing projects with `.agentful/product-analysis.json`:

```bash
# Move the file
mv .agentful/product-analysis.json .claude/product/product-analysis.json

# Commit to git
git add .claude/product/product-analysis.json
git commit -m "Move product analysis to user config directory"
```

The file will be automatically regenerated in the correct location when you run `/agentful-product` next.

## Testing Recommendations

1. Test `/agentful-product` command - verify it writes to `.claude/product/product-analysis.json`
2. Test `/agentful-status` command - verify it reads from `.claude/product/product-analysis.json`
3. Test orchestrator readiness check - verify it reads from `.claude/product/product-analysis.json`
4. Verify `.gitignore` properly ignores `.agentful/` and `.claude/agents/ephemeral/`
5. Verify documentation is accurate across all pages

## Completion Status

✅ All `product-analysis.json` references audited and fixed
✅ Directory structure documented everywhere
✅ `.agentful/` vs `.claude/` separation explained
✅ Ephemeral agents directory structure defined
✅ Comprehensive ARCHITECTURE.md created
✅ README.md updated with full file list
✅ Template files updated
✅ .gitignore updated
✅ All state files documented
✅ Migration path documented

**Audit Complete**: All file references are now consistent with the correct structure.
