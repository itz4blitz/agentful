name: Test

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [22.x]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        run: npm run test:unit

      - name: Run validation tests
        run: npm run test:validation

      - name: Run all tests with coverage
        run: npm run test:coverage

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Check coverage thresholds
        run: |
          COVERAGE=$(node -e "const cov = require('./coverage/coverage-summary.json'); console.log(cov.total.lines.pct)")
          echo "Coverage: ${COVERAGE}%"
          if (( $(echo "$COVERAGE < 80" | bc -l) )); then
            echo "❌ Coverage below 80% threshold"
            exit 1
          fi
          echo "✅ Coverage meets 80% threshold"

  lint:
    name: Lint Code
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check for TypeScript errors (if applicable)
        run: |
          if [ -f tsconfig.json ]; then
            npx tsc --noEmit
          else
            echo "No TypeScript configuration found, skipping"
          fi

      - name: Validate JSON files
        run: |
          echo "Validating JSON files..."
          find . -name "*.json" -not -path "./node_modules/*" -not -path "./coverage/*" | while read file; do
            if ! jq empty "$file" 2>/dev/null; then
              echo "❌ Invalid JSON: $file"
              exit 1
            fi
          done
          echo "✅ All JSON files are valid"

      - name: Check for debugging artifacts
        run: |
          echo "Checking for console.log and debugger statements..."
          if grep -r "console\.log\|debugger" lib/ bin/ --include="*.js" 2>/dev/null; then
            echo "⚠️  Warning: Found debugging statements in code"
          else
            echo "✅ No debugging statements found"
          fi

  validate-structure:
    name: Validate Project Structure
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate required files exist
        run: |
          echo "Validating required files..."
          required_files=(
            "package.json"
            "version.json"
            "README.md"
            "LICENSE"
            "bin/cli.js"
            "lib/index.js"
            "lib/init.js"
            ".claude/agents/orchestrator.md"
            ".claude/agents/frontend.md"
            ".claude/agents/backend.md"
            ".claude/agents/tester.md"
            ".claude/agents/reviewer.md"
            ".claude/commands/agentful.md"
            ".claude/commands/agentful-start.md"
            ".claude/commands/agentful-status.md"
          )

          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "❌ Missing required file: $file"
              exit 1
            fi
          done
          echo "✅ All required files exist"

      - name: Validate package.json structure
        run: |
          echo "Validating package.json..."
          node -e "
            const pkg = require('./package.json');
            const required = ['name', 'version', 'description', 'bin', 'type', 'license'];
            const missing = required.filter(field => !pkg[field]);
            if (missing.length > 0) {
              console.error('❌ Missing fields in package.json:', missing.join(', '));
              process.exit(1);
            }
            if (pkg.type !== 'module') {
              console.error('❌ package.json type must be \"module\"');
              process.exit(1);
            }
            if (!pkg.bin || !pkg.bin.agentful) {
              console.error('❌ package.json must have bin.agentful entry');
              process.exit(1);
            }
            console.log('✅ package.json structure is valid');
          "

      - name: Validate version consistency
        run: |
          echo "Validating version consistency..."
          PKG_VERSION=$(node -e "console.log(require('./package.json').version)")
          VERSION_JSON=$(node -e "console.log(require('./version.json').version)")

          if [ "$PKG_VERSION" != "$VERSION_JSON" ]; then
            echo "❌ Version mismatch: package.json ($PKG_VERSION) != version.json ($VERSION_JSON)"
            exit 1
          fi
          echo "✅ Versions are consistent: $PKG_VERSION"

  security:
    name: Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.x
          cache: 'npm'

      - name: Run npm audit
        run: |
          npm audit --audit-level=moderate || true

      - name: Check for hardcoded secrets
        run: |
          echo "Checking for hardcoded secrets..."
          if grep -rE "(password|secret|api[_-]?key|token).*=.*['\"][\w]{8,}" lib/ bin/ --include="*.js" 2>/dev/null; then
            echo "⚠️  Warning: Possible hardcoded secrets found"
          else
            echo "✅ No obvious hardcoded secrets found"
          fi

  test-installation:
    name: Test Package Installation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.x

      - name: Pack package
        run: npm pack

      - name: Install packed package globally
        run: npm install -g itz4blitz-agentful-*.tgz

      - name: Test CLI is accessible
        run: |
          if ! command -v agentful &> /dev/null; then
            echo "❌ agentful command not found after installation"
            exit 1
          fi
          echo "✅ agentful command is accessible"

      - name: Test CLI --version
        run: |
          VERSION=$(agentful --version)
          echo "Installed version: $VERSION"
          if [ -z "$VERSION" ]; then
            echo "❌ Could not get version from CLI"
            exit 1
          fi
          echo "✅ CLI --version works"

      - name: Test CLI help
        run: |
          agentful help
          echo "✅ CLI help works"

      - name: Test init in temporary directory
        run: |
          mkdir -p /tmp/test-agentful
          cd /tmp/test-agentful
          echo "y" | agentful init || true
          if [ ! -d ".agentful" ]; then
            echo "❌ Init did not create .agentful directory"
            exit 1
          fi
          echo "✅ Init works correctly"
