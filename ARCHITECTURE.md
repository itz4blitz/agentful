# agentful Architecture

This document explains the file organization and separation of concerns in agentful.

## Directory Structure

```
your-project/
├── .claude/                # User-customizable configuration (VERSION CONTROL THIS)
│   ├── agents/             # Agent definitions
│   │   ├── orchestrator.md
│   │   ├── backend.md
│   │   ├── frontend.md
│   │   ├── tester.md
│   │   ├── reviewer.md
│   │   ├── fixer.md
│   │   ├── architect.md
│   │   ├── product-analyzer.md
│   │   └── ephemeral/      # One-off temporary agents (GITIGNORED)
│   │       └── *.md        # Created on-demand, deleted after use
│   ├── commands/           # Slash commands
│   │   ├── agentful.md
│   │   ├── agentful-product.md
│   │   ├── agentful-start.md
│   │   ├── agentful-status.md
│   │   ├── agentful-decide.md
│   │   └── agentful-validate.md
│   ├── product/            # Product specifications (USER EDITABLE)
│   │   ├── index.md        # Main product spec
│   │   ├── product-analysis.json  # Readiness analysis (GENERATED)
│   │   └── domains/        # Optional hierarchical structure
│   │       └── {domain}/
│   │           ├── index.md
│   │           └── features/
│   │               └── {feature}.md
│   ├── skills/             # Reusable skill modules
│   │   ├── product-tracking/
│   │   ├── validation/
│   │   └── conversation/
│   └── settings.json       # Project-level configuration
│
└── .agentful/              # Runtime state (GITIGNORED, MANAGED BY NPM PACKAGE)
    ├── state.json          # Current work state
    ├── completion.json     # Feature completion tracking
    ├── decisions.json      # Pending/resolved decisions
    ├── architecture.json   # Detected tech stack
    ├── last-validation.json       # Latest validation results
    └── conversation-history.json  # Session tracking
```

## File Separation Principles

### `.claude/` - User Configuration (Version Controlled)

**Purpose**: User-customizable configuration that defines how agentful behaves in your project.

**What goes here:**
- Agent definitions (how agents should work)
- Slash commands (what commands are available)
- Product specifications (what to build)
- Skills (reusable capabilities)
- Settings (project preferences)

**Version control**: ✅ YES - Commit to git
**Shared across team**: ✅ YES - All developers use same config
**Modified by**: Human developers (you edit these files)

#### Special Case: `.claude/product/product-analysis.json`

This file is an **exception** to the user-editable rule:
- **Location**: `.claude/product/product-analysis.json`
- **Generated by**: `/agentful-product` command (product-analyzer agent)
- **Purpose**: Stores analysis of product specification readiness
- **Version control**: ✅ YES - Helps team track spec quality over time
- **Modified by**: agentful (regenerated on each `/agentful-product` run)
- **User action**: Review the analysis, update `index.md` to address issues, re-run analysis

**Why in `.claude/` not `.agentful/`?**
- Product analysis is configuration-like (it describes spec quality)
- Valuable for code review (shows what requirements were validated)
- Helps new team members understand spec completeness
- Persists across sessions (not transient runtime state)

#### Special Case: `.claude/agents/ephemeral/`

This subdirectory is **gitignored** for temporary agents:
- **Location**: `.claude/agents/ephemeral/*.md`
- **Created by**: Orchestrator for one-off tasks
- **Purpose**: Specialized agents for non-repeating work (migrations, audits, cleanups)
- **Version control**: ❌ NO - Gitignored
- **Lifecycle**: Created → Used → Deleted/Archived
- **Modified by**: agentful (auto-generated and cleaned up)

### `.agentful/` - Runtime State (Gitignored)

**Purpose**: Transient runtime state managed by the agentful npm package during development sessions.

**What goes here:**
- Current work tracking (what's being built right now)
- Progress snapshots (how far along each feature is)
- Pending decisions (blocking questions for the user)
- Detected architecture (auto-analyzed tech stack)
- Validation reports (latest test/lint results)
- Conversation history (session tracking)

**Version control**: ❌ NO - Always gitignored
**Shared across team**: ❌ NO - Each developer has their own state
**Modified by**: agentful npm package (automated)

**Why gitignored?**
- State is specific to each developer's session
- Changes constantly (every iteration updates state)
- Not meaningful for code review
- Regenerated automatically when starting new session
- Like `node_modules/` - necessary locally, wrong to commit

## File Organization by Purpose

### Product Specification Files

| File | Location | Version Control | Purpose | Modified By |
|------|----------|----------------|---------|-------------|
| `PRODUCT.md` | Root or `.claude/product/index.md` | ✅ YES | Main product spec | Human |
| `product-analysis.json` | `.claude/product/` | ✅ YES | Spec readiness score | agentful |
| Domain specs | `.claude/product/domains/` | ✅ YES | Feature details | Human |

**Key Point**: Product analysis is configuration because it's a durable assessment of your requirements quality, not transient runtime state.

### State Tracking Files

| File | Location | Version Control | Purpose | Modified By |
|------|----------|----------------|---------|-------------|
| `state.json` | `.agentful/` | ❌ NO | Current work | agentful |
| `completion.json` | `.agentful/` | ❌ NO | Progress tracking | agentful |
| `decisions.json` | `.agentful/` | ❌ NO | Pending decisions | agentful |
| `architecture.json` | `.agentful/` | ❌ NO | Tech stack detection | agentful |
| `last-validation.json` | `.agentful/` | ❌ NO | Test/lint results | agentful |
| `conversation-history.json` | `.agentful/` | ❌ NO | Session tracking | agentful |

### Agent Definition Files

| File | Location | Version Control | Purpose | Modified By |
|------|----------|----------------|---------|-------------|
| Core agents | `.claude/agents/*.md` | ✅ YES | Core workflow agents | agentful (shipped) + Human (customized) |
| Ephemeral agents | `.claude/agents/ephemeral/*.md` | ❌ NO | One-off task agents | agentful (temp) |

## Why This Separation Matters

### For Version Control

**Commit to git:**
- `.claude/` folder (except `ephemeral/`)
- All product specifications
- Product analysis (shows spec evolution)
- Custom agent modifications
- Project settings

**Do NOT commit:**
- `.agentful/` folder (runtime state)
- `.claude/agents/ephemeral/` (temporary agents)

### For Team Collaboration

**Shared across team:**
- Product specifications (what to build)
- Product analysis (quality assessment)
- Agent configurations (how to build)
- Commands and skills (team workflows)

**Individual to each developer:**
- Current work state (what I'm working on now)
- Local completion tracking (my progress)
- My pending decisions (blocking me)
- My session history (my conversations)

### For Upgrades

When agentful framework updates:

**Safe to upgrade** (npm package updates these):
- `.agentful/*` files (regenerated fresh)
- Core agent templates in `.claude/agents/`

**Preserved** (your customizations kept):
- Product specifications
- Custom agent modifications
- Project-specific settings
- Product analysis history

## Common Scenarios

### Scenario 1: Starting Fresh on Existing Project

**What you have:**
- Git clone of project
- `.claude/` folder (from git)
- No `.agentful/` folder (gitignored)

**What happens:**
1. Run `/agentful-start`
2. agentful creates fresh `.agentful/` directory
3. Reads product spec from `.claude/product/`
4. Reads product analysis from `.claude/product/product-analysis.json`
5. Initializes state for your session
6. Begins autonomous development

### Scenario 2: Analyzing Product Spec

**What you do:**
1. Edit `.claude/product/index.md` (your product spec)
2. Run `/agentful-product`

**What happens:**
1. product-analyzer reads your spec
2. Analyzes for completeness, clarity, etc.
3. Writes results to `.claude/product/product-analysis.json`
4. You commit both files to git
5. Team sees your spec + its quality assessment

### Scenario 3: Switching Branches

**Branch A** (your feature branch):
- `.claude/product/` has your new feature spec
- `.claude/product/product-analysis.json` shows 85% readiness
- `.agentful/state.json` says "working on auth"

**Switch to Branch B** (teammate's feature):
- `.claude/product/` has different features (from git)
- `.claude/product/product-analysis.json` different (from git)
- `.agentful/state.json` STILL says "working on auth" (not tracked by git)

**Solution**: Run `/agentful-start` to reset state for new branch.

### Scenario 4: One-Off Migration Task

**What you do:**
1. Ask orchestrator: "Migrate user data from MongoDB to PostgreSQL"

**What happens:**
1. Orchestrator recognizes one-off task
2. Creates `.claude/agents/ephemeral/mongo-to-postgres-migration.md`
3. Spawns ephemeral agent
4. Agent completes migration
5. Orchestrator deletes ephemeral agent file
6. No git commits needed (ephemeral/ is gitignored)

## Migration Notes

### If you have old references to `.agentful/product-analysis.json`:

**Wrong**:
```bash
Read(".agentful/product-analysis.json")
```

**Correct**:
```bash
Read(".claude/product/product-analysis.json")
```

All references to `product-analysis.json` should point to `.claude/product/`.

### If you manually created product-analysis.json in `.agentful/`:

Move it:
```bash
mv .agentful/product-analysis.json .claude/product/product-analysis.json
git add .claude/product/product-analysis.json
git commit -m "Move product analysis to user config directory"
```

## Summary

| Directory | Purpose | Version Control | Modified By | Shared Across Team |
|-----------|---------|----------------|-------------|-------------------|
| `.claude/agents/` | Agent definitions | ✅ YES | Human + agentful | ✅ YES |
| `.claude/agents/ephemeral/` | Temp agents | ❌ NO | agentful | ❌ NO |
| `.claude/commands/` | Slash commands | ✅ YES | Human + agentful | ✅ YES |
| `.claude/product/` | Product specs | ✅ YES | Human + agentful | ✅ YES |
| `.claude/product/product-analysis.json` | Spec analysis | ✅ YES | agentful | ✅ YES |
| `.claude/skills/` | Reusable skills | ✅ YES | Human + agentful | ✅ YES |
| `.claude/settings.json` | Configuration | ✅ YES | Human | ✅ YES |
| `.agentful/` | Runtime state | ❌ NO | agentful | ❌ NO |

**Golden Rule**: If it's about **what to build** or **how to build it**, it goes in `.claude/`. If it's about **current progress** or **session state**, it goes in `.agentful/`.
